<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXPLAINIUM - Knowledge Extraction</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .upload-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .documents-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #ddd; padding: 40px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
        .upload-area.dragover { border-color: #007bff; background: #f8f9ff; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.processing { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .document-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .document-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .document-title { font-weight: bold; color: #333; }
        .document-meta { color: #666; font-size: 0.9em; }
        .knowledge-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        .knowledge-item { background: #f8f9fa; padding: 10px; border-radius: 4px; border-left: 4px solid #007bff; }
        .knowledge-type { font-weight: bold; color: #007bff; font-size: 0.8em; text-transform: uppercase; }
        .knowledge-name { font-weight: 500; margin: 5px 0; }
        .knowledge-details { color: #666; font-size: 0.9em; white-space: pre-line; line-height: 1.4; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .hidden { display: none; }
        .progress-bar { width: 100%; height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #007bff; transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† EXPLAINIUM</h1>
            <p>Enterprise Knowledge Extraction System</p>
        </div>

        <div class="upload-section">
            <h2>Upload Documents</h2>
            <div class="upload-area" id="uploadArea">
                <p>üìÑ Drag and drop files here or click to select</p>
                <input type="file" id="fileInput" multiple accept=".pdf,.txt,.docx,.pptx" style="display: none;">
                <button class="btn" onclick="document.getElementById('fileInput').click()">Select Files</button>
            </div>
            <div id="uploadStatus"></div>
        </div>

        <div class="documents-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Processed Documents</h2>
                <button class="btn" onclick="loadDocuments()">üîÑ Refresh</button>
            </div>
            <div id="documentsContainer">
                <div class="loading">Loading documents...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let uploadTasks = new Map();

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupUpload();
            loadDocuments();
            setInterval(checkUploadProgress, 2000); // Check progress every 2 seconds
        });

        function setupUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => uploadFile(file));
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = `<div class="status processing">üì§ Uploading ${file.name}...</div>`;

            try {
                const response = await fetch(`${API_BASE}/uploadfile/`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    uploadTasks.set(result.task_id, {
                        filename: file.name,
                        status: 'processing',
                        startTime: Date.now()
                    });
                    
                    statusDiv.innerHTML = `<div class="status processing">‚öôÔ∏è Processing ${file.name}... <div class="progress-bar"><div class="progress-fill" style="width: 10%"></div></div></div>`;
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå Upload failed: ${result.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Upload failed: ${error.message}</div>`;
            }
        }

        async function checkUploadProgress() {
            if (uploadTasks.size === 0) return;

            const statusDiv = document.getElementById('uploadStatus');
            let allCompleted = true;

            for (const [taskId, task] of uploadTasks.entries()) {
                if (task.status === 'processing') {
                    allCompleted = false;
                    const elapsed = (Date.now() - task.startTime) / 1000;
                    const progress = Math.min(90, 10 + elapsed * 2); // Simulate progress
                    
                    statusDiv.innerHTML = `<div class="status processing">‚öôÔ∏è Processing ${task.filename}... (${elapsed.toFixed(0)}s) <div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div></div>`;
                }
            }

            // Check if any documents were recently added
            try {
                const response = await fetch(`${API_BASE}/documents/`);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const latestDoc = data.items[0];
                    const docTime = new Date(latestDoc.processing_timestamp);
                    const now = new Date();
                    
                    // If document was processed in the last 10 seconds, consider it newly completed
                    if ((now - docTime) < 10000) {
                        uploadTasks.clear();
                        statusDiv.innerHTML = `<div class="status success">‚úÖ Document processed successfully!</div>`;
                        setTimeout(() => {
                            statusDiv.innerHTML = '';
                            loadDocuments();
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Error checking progress:', error);
            }
        }

        async function loadDocuments() {
            const container = document.getElementById('documentsContainer');
            container.innerHTML = '<div class="loading">Loading documents...</div>';

            try {
                const response = await fetch(`${API_BASE}/documents/`);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    container.innerHTML = data.items.map(doc => createDocumentCard(doc)).join('');
                    
                    // Load knowledge data for each document
                    data.items.forEach(doc => loadKnowledgeData(doc.id));
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>No documents yet</h3>
                            <p>Upload documents above to start extracting knowledge</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå Failed to load documents: ${error.message}</div>`;
            }
        }

        function createDocumentCard(doc) {
            return `
                <div class="document-card" id="doc-${doc.id}">
                    <div class="document-header">
                        <div>
                            <div class="document-title">üìÑ ${doc.filename}</div>
                            <div class="document-meta">
                                ${doc.classification_category} ‚Ä¢ 
                                ${new Date(doc.processing_timestamp).toLocaleString()} ‚Ä¢ 
                                ${doc.extracted_text.length} chars
                            </div>
                        </div>
                    </div>
                    <div id="knowledge-${doc.id}" class="knowledge-grid">
                        <div class="loading">Loading knowledge data...</div>
                    </div>
                </div>
            `;
        }

        async function loadKnowledgeData(docId) {
            const container = document.getElementById(`knowledge-${docId}`);
            const knowledgeItems = [];

            try {
                // Load different types of knowledge data
                const endpoints = [
                    { type: 'Equipment', url: `/documents/${docId}/equipment/`, icon: '‚öôÔ∏è' },
                    { type: 'Procedures', url: `/documents/${docId}/procedures/`, icon: 'üìã' },
                    { type: 'Safety Info', url: `/documents/${docId}/safety_info/`, icon: '‚ö†Ô∏è' },
                    { type: 'Technical Specs', url: `/documents/${docId}/technical_specs/`, icon: 'üìä' },
                    { type: 'Personnel', url: `/documents/${docId}/personnel/`, icon: 'üë§' }
                ];

                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(`${API_BASE}${endpoint.url}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (Array.isArray(data) && data.length > 0) {
                                data.forEach(item => {
                                    knowledgeItems.push({
                                        type: endpoint.type,
                                        icon: endpoint.icon,
                                        name: item.name || item.title || item.parameter || item.hazard || 'Unknown',
                                        details: formatDetails(item, endpoint.type),
                                        confidence: item.confidence
                                    });
                                });
                            }
                        }
                    } catch (error) {
                        console.warn(`Failed to load ${endpoint.type}:`, error);
                    }
                }

                if (knowledgeItems.length > 0) {
                    container.innerHTML = knowledgeItems.map(item => `
                        <div class="knowledge-item">
                            <div class="knowledge-type">${item.icon} ${item.type}</div>
                            <div class="knowledge-name">${item.name}</div>
                            <div class="knowledge-details">${item.details}</div>
                            ${item.confidence ? `<div style="font-size: 0.8em; color: #28a745;">Confidence: ${(item.confidence * 100).toFixed(0)}%</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="color: #666; font-style: italic;">No structured knowledge extracted</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="status error">Failed to load knowledge data</div>`;
            }
        }

        function formatDetails(item, type) {
            switch (type) {
                case 'Equipment':
                    const specs = item.specifications || {};
                    const formatKey = (key) => {
                        return key
                            .replace(/_/g, ' ')
                            .replace(/([A-Z])/g, ' $1')
                            .replace(/\b\w/g, l => l.toUpperCase())
                            .trim();
                    };
                    return Object.entries(specs).map(([key, value]) => `‚Ä¢ ${formatKey(key)}: ${value}`).join('\n') || 'No specifications';
                case 'Procedures':
                    return `${item.steps?.length || 0} steps ‚Ä¢ ${item.category || 'General'}`;
                case 'Safety Info':
                    return `${item.precaution || 'See document'} ‚Ä¢ PPE: ${item.ppe_required || 'Not specified'}`;
                case 'Technical Specs':
                    return `${item.value} ${item.unit || ''} ${item.tolerance ? `(¬±${item.tolerance})` : ''}`;
                case 'Personnel':
                    return `${item.role || 'Unknown role'} ‚Ä¢ ${item.certifications?.join(', ') || 'No certifications'}`;
                default:
                    return 'Details available in document';
            }
        }
    </script>
</body>
</html>